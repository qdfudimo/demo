<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>微信语音通话</title>
  <script src="./js/tailwindcss.js"></script>
  <link href="./css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind自定义颜色 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            wechat: {
              green: '#07C160',
              light: '#E5E5EA',
              gray: '#F5F5F5',
              dark: '#333333',
              red: '#F43F5E'
            }
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .pulse-ring {
        box-shadow: 0 0 0 rgba(7, 193, 96, 0.4);
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(7, 193, 96, 0.7);
        }
        70% {
          box-shadow: 0 0 0 15px rgba(7, 193, 96, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(7, 193, 96, 0);
        }
      }
      .shake {
        animation: shake 0.5s;
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
      }
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">
  <!-- 登录界面 -->
  <div id="loginScreen" class="flex-1 flex flex-col items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-6">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-wechat-green rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-weixin text-white text-2xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-wechat-dark">微信语音通话</h1>
        <p class="text-gray-500 mt-2">请输入您的昵称开始通话</p>
      </div>
      
      <div class="mb-6">
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">您的昵称</label>
        <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wechat-green focus:border-wechat-green transition-all" placeholder="请输入昵称">
      </div>
      
      <div class="text-xs text-gray-500 mb-6 text-center">
        服务器地址: https://peer.nodcat.com
      </div>
      
      <button id="startBtn" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-opacity-90 transition-all flex items-center justify-center">
        <i class="fa fa-microphone mr-2"></i> 开始使用
      </button>
    </div>
  </div>

  <!-- 连接界面 (默认隐藏) -->
  <div id="connectScreen" class="hidden flex flex-col h-full">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 py-3 px-4 flex items-center shadow-sm">
      <div class="flex items-center">
        <button id="backBtn" class="mr-3 text-gray-600 hover:text-wechat-green">
          <i class="fa fa-arrow-left"></i>
        </button>
        <h2 class="font-medium text-wechat-dark">语音通话</h2>
      </div>
      <div class="ml-auto text-sm text-gray-500" id="connectionState">状态: 未连接</div>
    </header>
    
    <!-- 连接信息区域 -->
    <div class="flex-1 flex flex-col items-center justify-center p-6">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-wechat-gray rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-exchange text-wechat-green text-3xl"></i>
        </div>
        <h3 class="text-lg font-medium text-wechat-dark mb-2">请交换ID进行连接</h3>
        <p class="text-gray-500 text-sm">您的ID</p>
        <div class="flex items-center justify-center mt-2">
          <span id="myPeerId" class="text-xl font-bold text-wechat-dark px-4 py-2 bg-wechat-gray rounded-lg"></span>
          <button id="copyIdBtn" class="ml-2 text-wechat-green hover:text-wechat-green/80">
            <i class="fa fa-copy"></i>
          </button>
        </div>
      </div>
      
      <div class="w-full max-w-xs">
        <label for="partnerPeerId" class="block text-sm font-medium text-gray-700 mb-1">对方ID</label>
        <div class="flex">
          <input type="text" id="partnerPeerId" placeholder="输入对方ID" class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-wechat-green focus:border-wechat-green transition-all">
          <button id="callBtn" class="bg-wechat-green text-white px-6 rounded-r-lg font-medium hover:bg-opacity-90 transition-all">
            <i class="fa fa-phone mr-1"></i> 呼叫
          </button>
        </div>
      </div>
      
      <div id="connectionStatus" class="mt-8 text-sm text-gray-500">
        等待连接...
      </div>
      
      <!-- 调试信息 -->
      <div id="debugInfo" class="mt-4 text-xs text-gray-400 hidden">
        <div>ICE状态: <span id="iceState">-</span></div>
        <div>音频状态: <span id="audioState">-</span></div>
      </div>
    </div>
  </div>
  
  <!-- 通话界面 (默认隐藏) -->
  <div id="callScreen" class="hidden bg-black text-white h-full flex flex-col">
    <!-- 通话信息 -->
    <div class="flex-1 flex flex-col items-center justify-center p-6">
      <div id="callerName" class="text-2xl font-medium mb-2"></div>
      <div id="callStatus" class="text-gray-300 mb-8">正在通话中...</div>
      
      <div class="relative">
        <div class="w-32 h-32 rounded-full bg-wechat-green/20 pulse-ring flex items-center justify-center">
          <i class="fa fa-user text-4xl text-wechat-green"></i>
        </div>
        <!-- 音量指示器 -->
        <div id="volumeIndicator" class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 flex space-x-1">
          <div class="w-1.5 h-3 bg-wechat-green rounded-full animate-pulse"></div>
          <div class="w-1.5 h-5 bg-wechat-green rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
          <div class="w-1.5 h-7 bg-wechat-green rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
        </div>
      </div>
    </div>
    
    <!-- 通话控制 -->
    <div class="py-8 px-6">
      <div class="flex justify-center items-center space-x-8">
        <button id="muteBtn" class="w-14 h-14 rounded-full bg-gray-700 flex items-center justify-center hover:bg-gray-600 transition-all">
          <i class="fa fa-microphone text-xl"></i>
        </button>
        <button id="speakerBtn" class="w-14 h-14 rounded-full bg-gray-700 flex items-center justify-center hover:bg-gray-600 transition-all">
          <i class="fa fa-volume-up text-xl"></i>
        </button>
        <button id="hangupBtn" class="w-16 h-16 rounded-full bg-wechat-red flex items-center justify-center hover:bg-opacity-90 transition-all">
          <i class="fa fa-phone text-xl transform rotate-135"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- 来电界面 (默认隐藏) -->
  <div id="incomingCallScreen" class="hidden bg-black text-white h-full flex flex-col">
    <div class="flex-1 flex flex-col items-center justify-center p-6">
      <div id="incomingCallerName" class="text-2xl font-medium mb-2"></div>
      <div class="text-gray-300 mb-8">正在呼叫...</div>
      
      <div class="w-32 h-32 rounded-full bg-gray-800 flex items-center justify-center">
        <i class="fa fa-user text-4xl text-white"></i>
      </div>
    </div>
    
    <!-- 来电控制 -->
    <div class="py-8 px-6">
      <div class="flex justify-center items-center space-x-16">
        <button id="rejectCallBtn" class="w-16 h-16 rounded-full bg-wechat-red flex items-center justify-center hover:bg-opacity-90 transition-all">
          <i class="fa fa-phone text-xl transform rotate-135"></i>
        </button>
        <button id="acceptCallBtn" class="w-16 h-16 rounded-full bg-wechat-green flex items-center justify-center hover:bg-opacity-90 transition-all">
          <i class="fa fa-phone text-xl"></i>
        </button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <script>
    // DOM元素
    const loginScreen = document.getElementById('loginScreen');
    const connectScreen = document.getElementById('connectScreen');
    const callScreen = document.getElementById('callScreen');
    const incomingCallScreen = document.getElementById('incomingCallScreen');
    
    const usernameInput = document.getElementById('username');
    const startBtn = document.getElementById('startBtn');
    const backBtn = document.getElementById('backBtn');
    
    const myPeerIdEl = document.getElementById('myPeerId');
    const copyIdBtn = document.getElementById('copyIdBtn');
    const partnerPeerIdInput = document.getElementById('partnerPeerId');
    const callBtn = document.getElementById('callBtn');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const connectionStateEl = document.getElementById('connectionState');
    
    const callerNameEl = document.getElementById('callerName');
    const callStatusEl = document.getElementById('callStatus');
    const muteBtn = document.getElementById('muteBtn');
    const speakerBtn = document.getElementById('speakerBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    const volumeIndicator = document.getElementById('volumeIndicator');
    
    const incomingCallerNameEl = document.getElementById('incomingCallerName');
    const acceptCallBtn = document.getElementById('acceptCallBtn');
    const rejectCallBtn = document.getElementById('rejectCallBtn');
    
    const debugInfoEl = document.getElementById('debugInfo');
    const iceStateEl = document.getElementById('iceState');
    const audioStateEl = document.getElementById('audioState');
    
    // 全局变量
    let peer;
    let mediaConnection;
    let stream;
    let remoteAudio;
    let username;
    let partnerName = "未知联系人";
    let isMuted = false;
    let isSpeakerOn = true;
    let incomingCallConnection = null;
    let audioContext;
    let analyser;
    let dataArray;
    
    // 固定的PeerJS服务器
    const PEER_SERVER = 'https://peer.nodcat.com';
    
    // 开始使用按钮点击事件
    startBtn.addEventListener('click', () => {
      username = usernameInput.value.trim();
      
      if (!username) {
        alert('请输入您的昵称');
        usernameInput.focus();
        return;
      }
      
      // 初始化Peer
      initPeer();
      
      // 切换到连接界面
      loginScreen.classList.add('hidden');
      connectScreen.classList.remove('hidden');
    });
    
    // 返回按钮点击事件
    backBtn.addEventListener('click', () => {
      // 关闭所有连接
      cleanupConnections();
      
      // 重置界面
      partnerPeerIdInput.value = '';
      connectionStatusEl.textContent = '等待连接...';
      connectionStatusEl.classList.remove('text-wechat-red');
      
      // 切换到登录界面
      connectScreen.classList.add('hidden');
      loginScreen.classList.remove('hidden');
    });
    
    // 复制ID按钮点击事件
    copyIdBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(myPeerIdEl.textContent)
        .then(() => {
          copyIdBtn.classList.add('shake');
          setTimeout(() => copyIdBtn.classList.remove('shake'), 500);
        })
        .catch(err => {
          console.error('无法复制文本: ', err);
        });
    });
    
    // 初始化Peer
    function initPeer() {
      const url = new URL(PEER_SERVER);
      
      peer = new Peer({
        host: url.hostname,
        port: url.port || (url.protocol === 'https:' ? 443 : 80),
        path: url.pathname || '/peerjs',
        secure: url.protocol === 'https:',
        debug: 3 // 开启详细日志
      });
      
      // 当Peer连接成功时
      peer.on('open', (id) => {
        console.log('My peer ID is: ' + id);
        myPeerIdEl.textContent = id;
        connectionStateEl.textContent = '状态: 已连接';
      });
      
      // 当有新的媒体连接请求时（来电）
      peer.on('call', (call) => {
        console.log('收到来电', call);
        incomingCallConnection = call;
        
        // 获取来电者信息
        if (call.metadata && call.metadata.username) {
          partnerName = call.metadata.username;
          incomingCallerNameEl.textContent = partnerName;
        } else {
          incomingCallerNameEl.textContent = "未知来电";
        }
        
        // 显示来电界面
        connectScreen.classList.add('hidden');
        incomingCallScreen.classList.remove('hidden');
        
        // 处理来电响应
        acceptCallBtn.onclick = async () => {
          try {
            // 获取本地媒体流
            stream = await navigator.mediaDevices.getUserMedia({ 
              audio: true, 
              video: false 
            });
            
            // 初始化音频分析器
            initAudioAnalyzer(stream);
            
            // 接听来电
            call.answer(stream);
            
            // 处理通话
            handleCall(call);
            
            // 隐藏来电界面，显示通话界面
            incomingCallScreen.classList.add('hidden');
            callerNameEl.textContent = partnerName;
            callScreen.classList.remove('hidden');
            
          } catch (err) {
            console.error('无法获取媒体设备:', err);
            alert('无法访问麦克风，请确保已授予权限');
            incomingCallScreen.classList.add('hidden');
            connectScreen.classList.remove('hidden');
          }
        };
        
        // 拒绝来电
        rejectCallBtn.onclick = () => {
          call.close();
          incomingCallConnection = null;
          incomingCallScreen.classList.add('hidden');
          connectScreen.classList.remove('hidden');
        };
      });
      
      // 处理错误
      peer.on('error', (err) => {
        console.error('Peer错误:', err);
        connectionStatusEl.textContent = `错误: ${err.message}`;
        connectionStatusEl.classList.add('text-wechat-red');
        connectionStateEl.textContent = '状态: 错误';
        
        if (err.type === 'unavailable-id' || err.type === 'server-error') {
          setTimeout(() => peer.reconnect(), 2000);
        }
      });
      
      // 当Peer断开连接时
      peer.on('disconnected', () => {
        console.log('Peer已断开连接');
        connectionStatusEl.textContent = '连接已断开，尝试重新连接...';
        connectionStateEl.textContent = '状态: 断开连接';
        peer.reconnect();
      });
    }
    
    // 初始化音频分析器
    function initAudioAnalyzer(stream) {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 32;
        
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        // 开始音量动画
        animateVolume();
      } catch (err) {
        console.error('音频分析器初始化失败:', err);
      }
    }
    
    // 音量动画
    function animateVolume() {
      if (!analyser) return;
      
      analyser.getByteFrequencyData(dataArray);
      
      // 更新音量指示器
      const volumeLevel = Math.max(dataArray[0] / 255, 0.1);
      const bars = volumeIndicator.children;
      
      for (let i = 0; i < bars.length; i++) {
        const scale = volumeLevel * (i + 1);
        bars[i].style.transform = `scaleY(${scale})`;
      }
      
      requestAnimationFrame(animateVolume);
    }
    
    // 呼叫按钮点击事件
    callBtn.addEventListener('click', async () => {
      const partnerId = partnerPeerIdInput.value.trim();
      
      if (!partnerId) {
        alert('请输入对方的ID');
        partnerPeerIdInput.focus();
        return;
      }
      
      try {
        connectionStatusEl.textContent = `正在呼叫 ${partnerId}...`;
        connectionStatusEl.classList.remove('text-wechat-red');
        
        // 获取本地媒体流（麦克风）
        stream = await navigator.mediaDevices.getUserMedia({ 
          audio: true, 
          video: false 
        });
        
        // 初始化音频分析器
        initAudioAnalyzer(stream);
        
        // 发起呼叫
        mediaConnection = peer.call(partnerId, stream, {
          metadata: {
            username: username
          }
        });
        
        // 处理通话
        handleCall(mediaConnection);
        
        // 更新界面
        callerNameEl.textContent = partnerId;
        connectScreen.classList.add('hidden');
        callScreen.classList.remove('hidden');
        
      } catch (err) {
        console.error('呼叫失败:', err);
        connectionStatusEl.textContent = `呼叫失败: ${err.message}`;
        connectionStatusEl.classList.add('text-wechat-red');
        
        // 清理流
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }
      }
    });
    
    // 处理通话连接
    function handleCall(call) {
      mediaConnection = call;
      
      // 创建远程音频元素并添加到DOM
      remoteAudio = new Audio();
      remoteAudio.autoplay = true;
      remoteAudio.style.display = 'none';
      document.body.appendChild(remoteAudio);
      
      // 显示调试信息
      debugInfoEl.classList.remove('hidden');
      
      call.on('stream', (remoteStream) => {
        console.log('收到远程流，轨道:', remoteStream.getTracks());
        audioStateEl.textContent = '已接收音频';
        
        remoteAudio.srcObject = remoteStream;
        
        // 处理自动播放限制
        const playPromise = remoteAudio.play();
        if (playPromise !== undefined) {
          playPromise.catch(error => {
            console.log('自动播放被阻止:', error);
            callStatusEl.textContent = '点击屏幕以启用声音';
            document.addEventListener('click', enableAudio, {once: true});
          });
        }
      });
      
      function enableAudio() {
        remoteAudio.play().then(() => {
          callStatusEl.textContent = '正在通话中...';
        }).catch(err => {
          console.error('无法播放音频:', err);
          callStatusEl.textContent = '无法播放音频';
        });
      }
      
      // ICE连接状态变化
      call.on('iceStateChanged', (state) => {
        console.log('ICE连接状态:', state);
        iceStateEl.textContent = state;
        
        if (state === 'disconnected' || state === 'failed') {
          endCall('连接断开');
        }
      });
      
      // 通话关闭事件
      call.on('close', () => {
        console.log('对方已挂断');
        endCall('对方已挂断');
      });
      
      // 通话错误
      call.on('error', (err) => {
        console.error('通话错误:', err);
        callStatusEl.textContent = `通话错误: ${err.message}`;
        setTimeout(() => endCall('因错误结束通话'), 2000);
      });
    }
    
    // 静音按钮点击事件
    muteBtn.addEventListener('click', () => {
      if (!stream) return;
      
      isMuted = !isMuted;
      
      // 切换所有音频轨道的静音状态
      stream.getAudioTracks().forEach(track => {
        track.enabled = !isMuted;
      });
      
      // 更新按钮样式
      if (isMuted) {
        muteBtn.classList.add('bg-wechat-red');
        muteBtn.classList.remove('bg-gray-700');
        muteBtn.innerHTML = '<i class="fa fa-microphone-slash text-xl"></i>';
      } else {
        muteBtn.classList.remove('bg-wechat-red');
        muteBtn.classList.add('bg-gray-700');
        muteBtn.innerHTML = '<i class="fa fa-microphone text-xl"></i>';
      }
    });
    
    // 扬声器按钮点击事件
    speakerBtn.addEventListener('click', () => {
      if (!remoteAudio) return;
      
      isSpeakerOn = !isSpeakerOn;
      
      // 切换扬声器/听筒模式
      if (remoteAudio.setSinkId) {
        remoteAudio.setSinkId(isSpeakerOn ? 'default' : '')
          .then(() => {
            console.log('音频输出切换成功');
          })
          .catch(err => {
            console.error('切换音频输出失败:', err);
          });
      }
      
      // 更新按钮样式
      if (isSpeakerOn) {
        speakerBtn.innerHTML = '<i class="fa fa-volume-up text-xl"></i>';
      } else {
        speakerBtn.innerHTML = '<i class="fa fa-volume-down text-xl"></i>';
      }
    });
    
    // 挂断按钮点击事件
    hangupBtn.addEventListener('click', () => {
      endCall('已挂断通话');
    });
    
    // 结束通话
    function endCall(statusMessage = '通话已结束') {
      // 1. 停止所有媒体轨道
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      // 2. 关闭音频上下文
      if (audioContext) {
        audioContext.close().catch(err => console.error('关闭音频上下文失败:', err));
        audioContext = null;
      }
      
      // 3. 关闭连接
      if (mediaConnection) {
        mediaConnection.close();
        mediaConnection = null;
      }
      
      // 4. 清理远程音频
      if (remoteAudio) {
        remoteAudio.pause();
        remoteAudio.srcObject = null;
        if (remoteAudio.parentNode) {
          remoteAudio.parentNode.removeChild(remoteAudio);
        }
        remoteAudio = null;
      }
      
      // 5. 清除来电连接
      if (incomingCallConnection) {
        incomingCallConnection = null;
      }
      
      // 6. 重置状态
      isMuted = false;
      isSpeakerOn = true;
      muteBtn.classList.remove('bg-wechat-red');
      muteBtn.classList.add('bg-gray-700');
      muteBtn.innerHTML = '<i class="fa fa-microphone text-xl"></i>';
      speakerBtn.innerHTML = '<i class="fa fa-volume-up text-xl"></i>';
      
      // 7. 切换界面
      setTimeout(() => {
        callScreen.classList.add('hidden');
        incomingCallScreen.classList.add('hidden');
        connectScreen.classList.remove('hidden');
        connectionStatusEl.textContent = statusMessage;
        debugInfoEl.classList.add('hidden');
      }, 1000);
    }
    
    // 清理所有连接
    function cleanupConnections() {
      endCall();
      
      if (peer) {
        peer.destroy();
        peer = null;
      }
    }
    
    // 页面关闭时清理连接
    window.addEventListener('beforeunload', cleanupConnections);
    
    // 监听页面可见性变化，自动静音
    document.addEventListener('visibilitychange', () => {
      if (stream && !callScreen.classList.contains('hidden')) {
        const shouldMute = document.hidden;
        if (shouldMute !== isMuted) {
          isMuted = shouldMute;
          stream.getAudioTracks().forEach(track => {
            track.enabled = !isMuted;
          });
          
          // 更新按钮样式
          if (isMuted) {
            muteBtn.classList.add('bg-wechat-red');
            muteBtn.classList.remove('bg-gray-700');
            muteBtn.innerHTML = '<i class="fa fa-microphone-slash text-xl"></i>';
          } else {
            muteBtn.classList.remove('bg-wechat-red');
            muteBtn.classList.add('bg-gray-700');
            muteBtn.innerHTML = '<i class="fa fa-microphone text-xl"></i>';
          }
        }
      }
    });
  </script>
</body>
</html>